下面是基于当前 `plumego` 仓库能力，面向“短信网关”场景需要具备的特性清单，以及 **plumego 目前欠缺/需要新增的能力**。我按“短信网关的完整能力面”来拆分，尽量详细但不做嵌套列表。

**短信网关需要实现的特性（完整面）**
- **对外 API 与接入**：发送短信（单发/批量）、查询状态、取消/过期、模板发送、回执订阅、入站短信（MO）回调、签名/鉴权（API Key/JWT）、幂等键、IP 白名单与访问审计。
- **消息生命周期与状态机**：消息状态（queued/sent/delivered/failed/expired）统一模型；状态迁移规则；失败原因标准化；重试与退避策略；DLQ（死信）与人工重放；超时与 TTL。
- **队列与异步处理**：发送队列、优先级、延迟发送、吞吐限速；高峰流量的削峰；任务并发控制；可恢复的消息调度与重试。
- **多供应商接入与路由**：HTTP/SMPP 连接器；供应商参数化（账号、签名、模板、通道）；多通道路由策略（成本、成功率、地区、运营商）；故障转移与降级。
- **内容与编码处理**：GSM-7/UTF-16 编码识别；长短信拆分与拼接计费；敏感词/合规模板校验；签名位置规则（含本地法规）。
- **号码与资源管理**：号码池、Sender ID、短码/长码管理；号码归属地/运营商映射；黑名单/白名单；退订管理（STOP/HELP）。
- **合规与安全**：双重确认/用户授权记录；退订流程；内容合规审核；数据脱敏与加密；日志与审计；留存与删除策略。
- **计费与额度**：账户余额、计费策略、账单、用量统计；租户配额；限速与防刷；异常扣费回滚。
- **可观测与运营**：吞吐/失败率/延迟指标；供应商 SLA 监控；告警；管理后台或运维 API。
- **数据存储**：发送记录、状态流、模板、用户授权、回执、供应商响应等持久化。
- **测试与沙箱**：供应商沙箱模式、回执模拟、批量压测工具、回归测试用例。

**plumego 已具备、可直接复用的基础能力**
- **HTTP 栈与生命周期**：`core`/`router`/`middleware` 提供标准 `net/http` 兼容的路由、中间件、优雅启停与超时控制。
- **安全与中间件**：日志、恢复、CORS、gzip、超时、限流、并发限制、请求体大小限制、安全头、基础认证等（可作为 API 接入层能力）。
- **Webhook 与 Pub/Sub**：`net/webhookin`/`net/webhookout` + `pubsub` 可用于接收供应商回执或将消息事件扇出。
- **调度与任务**：`scheduler` 适合做延迟发送或重试的基础调度。
- **存储**：`store/kv` 是带 WAL 的内嵌 KV（适合做幂等、去重、短期状态、缓存）。
- **多租户（实验）**：`tenant` 模块可用于租户隔离、配额与策略控制。
- **可观测性**：`metrics` 包包含 Prometheus/OTel 适配，`log` 提供结构化日志扩展点。

**plumego 当前欠缺/需要新增的短信网关关键能力**
- **短信供应商连接器**：缺少 SMPP/HTTP 供应商适配器、鉴权签名、参数映射、错误码归一、回执协议解析。
- **消息生命周期体系**：缺少统一的消息状态机、失败原因模型、重试/退避策略、死信队列与人工重放管理。
- **可靠队列/持久化消息处理**：现有 `pubsub`/`net/mq` 是进程内模型，不是持久化、分布式队列；短信网关常需要可靠持久队列与可恢复任务执行。
- **长短信拆分与编码处理**：缺少 GSM-7/UTF-16 编码识别与分段计费逻辑。
- **模板与签名管理**：缺少模板审核、签名位置规则、地区合规校验、模板版本控制。
- **号码池/通道管理**：缺少号码资源池、Sender ID 管理、按地区/运营商路由策略。
- **合规与退订机制**：缺少 STOP/HELP 处理、用户授权留存、黑名单管理与合规审计。
- **计费与结算**：缺少账户余额、计费策略、账单与对账、超额处理与退款逻辑。
- **运营与管理后台**：缺少管理 API/后台（模板、通道、回执、审计、告警等）。
- **数据模型与持久化方案**：缺少发送记录、回执、模板、授权等核心表结构与持久存储方案。

**一个现实的落地切分（便于评估工作量）**
- **阶段 1（MVP）**：对外发送 API + 1 家供应商连接器 + 基本回执 + 幂等 + 发送记录持久化 + 限流与鉴权。
- **阶段 2（可靠性）**：持久队列 + 重试/退避 + DLQ + 状态机 + 监控指标。
- **阶段 3（产品化）**：模板管理/审核、号码池/路由策略、退订与合规、计费结算、运营后台。

如果你愿意，我可以把上面内容进一步细化成“功能清单 + 技术拆分 + 数据模型草案 + 路由/API 设计”。  
为了更精准落地，需要你补充 3 个信息：  
1. 计划对接哪些短信供应商（国内/海外）？  
2. 预期规模（QPS/日发送量）与可靠性要求？  
3. 是否多租户与计费是硬需求？





下面是基于你给的约束（国内供应商、QPS≈1000、日 20 万、SLO 99.99%、多租户+计费硬需求）的 **短信网关详细设计**。我按“可落地的模块划分 + 数据模型 + API + 关键流程 + 可靠性策略 + 与 plumego 的对应点”来组织，便于后续拆任务。

**目标与边界**
- 目标：国内短信网关，面向多租户，支持高并发发送、可靠投递、回执与计费、强审计与合规。
- 可靠性：99.99%（年中断 < 52.6 分钟），需要持久化、可恢复队列与可观测性。
- QPS 1000 峰值远高于日均，需要削峰、限流、弹性并发。

**总体架构（建议拆成 2~3 个服务）**
- `api-gateway`：对外 API、鉴权、限流、租户、校验、写入消息队列或存储。
- `sender-worker`：消费待发送消息、路由选通道、发送、重试、更新状态。
- `callback-ingest`：接收供应商回执/上行短信（MO），更新状态并产生计费事件。
- 可选 `admin-console`：运营管理与配置（模板、签名、通道、路由、账单）。

**与 plumego 的对应点**
- `core/router/middleware`：API 服务与回调服务基础。
- `middleware`：鉴权、限流、并发、超时、请求体限制、安全头。
- `tenant`：租户解析、配额、策略控制。
- `pubsub/scheduler`：可用于本进程事件与延迟重试的“调度层”，但可靠性要求需要持久化队列。
- `store/kv`：适合幂等、短期去重、回执窗口缓存，不适合作为主消息库。
- `metrics/log`：指标与审计日志。

**关键能力拆分（服务内模块）**
- `ProviderAdapter`：供应商接口适配（HTTP/SMPP）、签名、模板参数映射、错误码归一。
- `RouteEngine`：路由策略（成本、可用率、地区、运营商、黑白名单）。
- `MessageStateMachine`：消息状态、尝试记录、失败原因、重试策略。
- `BillingEngine`：计费、余额、冻结额度、结算与对账。
- `Compliance`：模板审核、签名位置规则、退订、黑名单。
- `TenantGuard`：租户配额与限速、API Key、审计。

**数据模型（建议核心表）**
- `tenants`：租户信息、状态、SLA、风险等级。
- `tenant_api_keys`：API Key、权限、IP 白名单、状态。
- `sender_signatures`：签名内容、审核状态、适用供应商。
- `templates`：模板内容、变量约束、审核状态、供应商模板 ID 映射。
- `providers`：供应商配置、鉴权、区域覆盖、成本参数。
- `routes`：路由策略规则（地区/运营商/费用/权重/回退）。
- `messages`：主消息表，字段含 `idempotency_key`、`status`、`tenant_id`、`template_id`、`to`、`body`、`provider_id`、`cost`、`created_at`、`expire_at`。
- `message_attempts`：每次发送尝试记录，含 `provider_req_id`、`error_code`、`latency_ms`、`retry_at`。
- `callbacks`：回执原始数据，便于审计与问题排查。
- `billing_accounts`：余额、冻结、信用额度、结算周期。
- `billing_ledger`：账单流水，事件式追加。
- `usage_daily`：按租户/通道/模板聚合统计。
- `opt_outs`：退订手机号集合（黑名单）。
- `number_pools`：可用通道或 Sender ID 资源（若适用）。

**API 设计（对外）**
- `POST /v1/messages`：发送短信（支持批量），返回 message_id。
- `GET /v1/messages/{id}`：查询状态。
- `POST /v1/messages/{id}/cancel`：取消未发送消息。
- `POST /v1/templates` / `GET /v1/templates`：模板管理。
- `POST /v1/signatures` / `GET /v1/signatures`：签名管理。
- `GET /v1/billing/usage` / `GET /v1/billing/ledger`：计费与用量。
- `POST /v1/route/test`：路由策略模拟（只读，便于运营）。

**回调 API（供应商回执与上行）**
- `POST /callback/provider/{name}/delivery`：状态回执。
- `POST /callback/provider/{name}/mo`：上行短信。
- 所有回调必须校验签名与防重放。

**关键流程（简化版本）**
- `发送`：API 校验 → 生成消息记录 → 幂等写入 → 入队 → 返回 message_id。
- `投递`：Worker 拉取消息 → RouteEngine 选择通道 → ProviderAdapter 发送 → 记录 attempt → 更新状态。
- `回执`：回调入站 → 校验 → 更新消息状态 → 触发计费事件。
- `重试`：失败可重试 → 延迟队列 → 最终失败 → DLQ + 运营可重放。

**可靠性设计（满足 99.99%）**
- 持久化队列或 DB 任务表，不能只用内存 `pubsub`。
- 消息入库与入队原子性，建议 `Outbox` 模式或“消息表 + 消费状态”设计。
- Worker 使用“租约 + 并发控制”拉取，防止重复投递。
- 幂等键（`idempotency_key`）必须全链路贯穿。
- 回执与发送尝试必须持久化，用于一致性修复。
- 供应商失败自动切换通道（策略化）。
- 灰度策略：新通道引流 1% 流量观察。

**性能与容量（QPS 1000）**
- API 入口限流每租户 + 全局限流。
- 并发发送的 worker 池，发送 IO 阻塞要隔离。
- 供应商接口通常限制 QPS，需要通道级限速。
- 优先考虑批量 API（若供应商支持），减少 RTT。
- 状态查询应走缓存或聚合表，避免热表压力。

**plumego 需要新增/扩展的能力（落到工程任务）**
- 供应商适配接口与多通道路由策略模块。
- 可靠队列或 DB-based 消费机制（plumego 自带的 `pubsub` 不够）。
- 消息状态机与重试策略。
- 编码处理与长短信拆分逻辑。
- 计费引擎与余额冻结/扣费流程。
- 模板/签名审核与合规规则。
- 回执统一处理与失败原因归一化。
- 运营/管理 API 与审计日志。

**建议的实现路线图**
1. **MVP**：发送 API + 单供应商 + 入站回执 + 幂等 + 持久化消息表 + 基础计费（扣费日志）。
2. **可靠性**：队列/租约消费 + 重试/退避 + DLQ + 状态机完善 + 指标体系。
3. **多通道与路由**：路由策略、自动切换、成本控制。
4. **合规与产品化**：模板/签名审核、退订、黑名单、运营后台。

**需要你确认的关键选择（直接影响设计）**
1. 你倾向使用哪种持久化存储（MySQL/PostgreSQL/其他）？
2. 允许引入外部消息队列吗（Kafka/Rabbit/NSQ/Redis Stream）？
3. 是否需要支持 SMPP，还是全部走 HTTP 供应商接口？

确认后我可以继续输出更细的内容：  
- 数据库表结构草案（字段级别）  
- 发送与回执的状态机图  
- 具体 plumego 组件落位（目录与接口定义）  
- 一期 MVP 的最小可交付清单与开发顺序




下面是**基于你给出的短信网关方案**，对 **当前 plumego 框架需要加强与完善的点** 的详细整理。重点是“框架层面的缺口”，不是应用业务本身。

**1. 可靠队列与任务执行框架（核心缺口）**
- 现状：`pubsub` / `scheduler` 都是进程内、非持久化；`net/mq` 实验状态。
- 需要补强：持久化队列、ACK/重试/退避、DLQ、租约式消费、防重复消费、延迟消息、出入队指标、优雅停机时的 in-flight 保护。
- 说明：短信网关的 99.99% 可靠性必须要“持久化 + 可恢复 + 可审计”。

**2. 消息状态机与幂等机制（框架缺少标准化）**
- 现状：无统一的消息状态机或幂等中间件。
- 需要补强：统一状态模型、失败原因归一、幂等键校验/存储接口（可用 `store/kv` 或外部 DB）、状态迁移规范与钩子。

**3. 多租户能力“稳定化”与计费支撑**
- 现状：`tenant` 为实验性，缺少计费/余额冻结/账单流水的基础设施。
- 需要补强：租户限流策略、租户额度、租户级路由策略缓存、租户计费事件钩子与审计通道。
- 说明：计费与多租户是硬需求，需要框架层提供“可插拔的计费/审计接口”。

**4. 通道级限速与路由策略支持**
- 现状：`middleware/ratelimit` 更偏向“客户端/IP”限速。
- 需要补强：按通道/供应商的速率限制、并发池、失败降级、动态路由策略与灰度流量支持。

**5. 通用的回调签名验证能力**
- 现状：`security` 里有 GitHub/Stripe webhook 验证，但偏场景化。
- 需要补强：通用 HMAC/签名验证模块、重放保护（时间窗 + nonce）、IP 白名单策略、统一的回调错误模型。

**6. 统一的请求绑定与校验链路**
- 现状：有 `validator`、`contract`，但缺少“标准化请求绑定+校验中间件”的一体化模式。
- 需要补强：输入结构体绑定、字段级错误返回规范、参数脱敏日志策略。

**7. 可观测性指标体系**
- 现状：有 `metrics` 框架适配，但无“短信网关关键指标模型”。
- 需要补强：队列长度、发送耗时、通道成功率、回执延迟、重试次数、状态分布等指标规范与统一上报接口。

**8. 审计与合规日志**
- 现状：日志框架有，但缺少“审计事件标准”.
- 需要补强：结构化审计日志接口（租户/模板/签名/通道变更、发送记录、回执更新、余额扣减）。

**9. 持久化与迁移支持**
- 现状：`store/kv` 适合缓存与幂等，不适合持久化消息表。
- 需要补强：对外提供“存储接口 + schema 管理建议 + 迁移基建”，或最小化的 SQL 模型支持（不引入重型 ORM）。

**10. 运维与管理能力**
- 现状：`debug` 端点适合本地调试，但生产管理能力不够。
- 需要补强：受保护的管理端点（队列状态、重放、回执追踪、通道健康、租户限额等）。

**11. 文档与示例**
- 现状：文档覆盖 Webhook、PubSub、生命周期，但缺少“高可靠网关型系统”示例。
- 需要补强：短信网关基线设计文档、关键模块组合示例、建议部署与扩展路线。

---

如果你认同，我可以把这些增强点进一步转成：

1. 具体的模块设计草案（包路径/接口定义/关键方法）  
2. 对应的“最小可实现版本(MVP)”规划  
3. 与现有目录的兼容落点（不破坏 `core/router/middleware` 的稳定性）

你希望我先从哪一块开始落细？  
1. 可靠队列与任务执行框架  
2. 多租户+计费接口  
3. 回调签名验证与合规/审计