package main

import (
	"context"
	"database/sql"
	"fmt"
	"log"
	"net/http"
	"time"

	_ "modernc.org/sqlite"

	"github.com/spcent/plumego/contract"
	"github.com/spcent/plumego/core"
	"github.com/spcent/plumego/router"
	"github.com/spcent/plumego/store/db"
)

// ================================================
// 1. å®šä¹‰æ•°æ®æ¨¡å‹
// ================================================

type UserModel struct {
	ID        string    `json:"id" db:"id"`
	Name      string    `json:"name" db:"name"`
	Email     string    `json:"email" db:"email"`
	Status    string    `json:"status" db:"status"`
	Role      string    `json:"role" db:"role"`
	CreatedAt time.Time `json:"created_at" db:"created_at"`
	UpdatedAt time.Time `json:"updated_at" db:"updated_at"`
}

// ================================================
// 2. å®ç° Repository
// ================================================

type UserRepository struct {
	*router.BaseRepository[UserModel]
}

func NewUserRepository(database db.DB) *UserRepository {
	builder := router.NewSQLBuilder("users", "id").
		WithColumns("id", "name", "email", "status", "role", "created_at", "updated_at").
		WithScanFunc(scanUser).
		WithInsertFunc(userInsertValues).
		WithUpdateFunc(userUpdateValues)

	return &UserRepository{
		BaseRepository: router.NewBaseRepository[UserModel](database, builder),
	}
}

func scanUser(rows *sql.Rows) (any, error) {
	var user UserModel
	err := rows.Scan(&user.ID, &user.Name, &user.Email, &user.Status, &user.Role, &user.CreatedAt, &user.UpdatedAt)
	if err != nil {
		return nil, err
	}
	return &user, nil
}

func userInsertValues(data any) ([]any, error) {
	user := data.(*UserModel)
	return []any{user.ID, user.Name, user.Email, user.Status, user.Role, user.CreatedAt, user.UpdatedAt}, nil
}

func userUpdateValues(data any) ([]any, error) {
	user := data.(*UserModel)
	return []any{user.Name, user.Email, user.Status, user.Role, user.UpdatedAt}, nil
}

// ================================================
// 3. å®ç°ç”Ÿå‘½å‘¨æœŸé’©å­
// ================================================

type UserHooks struct {
	router.NoOpResourceHooks
}

func (h *UserHooks) BeforeCreate(ctx context.Context, data any) error {
	user := data.(*UserModel)

	// è®¾ç½®æ—¶é—´æˆ³
	now := time.Now()
	user.CreatedAt = now
	user.UpdatedAt = now

	// ç”Ÿæˆ ID
	if user.ID == "" {
		user.ID = fmt.Sprintf("user-%d", now.UnixNano())
	}

	// è®¾ç½®é»˜è®¤å€¼
	if user.Status == "" {
		user.Status = "active"
	}
	if user.Role == "" {
		user.Role = "user"
	}

	log.Printf("[Hooks] Creating user: %s (%s)", user.Name, user.Email)
	return nil
}

func (h *UserHooks) AfterCreate(ctx context.Context, data any) error {
	user := data.(*UserModel)
	log.Printf("[Hooks] User created successfully: %s (ID: %s)", user.Name, user.ID)
	return nil
}

func (h *UserHooks) BeforeUpdate(ctx context.Context, id string, data any) error {
	user := data.(*UserModel)
	user.UpdatedAt = time.Now()
	log.Printf("[Hooks] Updating user: %s", id)
	return nil
}

func (h *UserHooks) AfterDelete(ctx context.Context, id string) error {
	log.Printf("[Hooks] User deleted: %s", id)
	return nil
}

// ================================================
// 4. å®ç°æ•°æ®è½¬æ¢å™¨
// ================================================

type UserTransformer struct{}

func (t *UserTransformer) Transform(ctx context.Context, resource any) (any, error) {
	user := resource.(*UserModel)
	return map[string]any{
		"id":         user.ID,
		"name":       user.Name,
		"email":      user.Email,
		"status":     user.Status,
		"role":       user.Role,
		"created_at": user.CreatedAt.Format(time.RFC3339),
		"updated_at": user.UpdatedAt.Format(time.RFC3339),
	}, nil
}

func (t *UserTransformer) TransformCollection(ctx context.Context, resources any) (any, error) {
	users := resources.([]UserModel)
	result := make([]map[string]any, len(users))
	for i, user := range users {
		transformed, err := t.Transform(ctx, &user)
		if err != nil {
			return nil, err
		}
		result[i] = transformed.(map[string]any)
	}
	return result, nil
}

// ================================================
// 5. åˆ›å»ºæ§åˆ¶å™¨
// ================================================

func NewUserController(database db.DB) *router.DBResourceController[UserModel] {
	repo := NewUserRepository(database)
	ctrl := router.NewDBResourceController[UserModel]("user", repo)

	// é…ç½®æŸ¥è¯¢å‚æ•°
	ctrl.QueryBuilder.
		WithPageSize(10, 50).
		WithAllowedSorts("name", "email", "created_at", "updated_at").
		WithAllowedFilters("status", "role")

	// é…ç½®é’©å­å’Œè½¬æ¢å™¨
	ctrl.Hooks = &UserHooks{}
	ctrl.Transformer = &UserTransformer{}

	return ctrl
}

// ================================================
// 6. æ•°æ®åº“åˆå§‹åŒ–
// ================================================

func initDatabase() (db.DB, error) {
	// ä½¿ç”¨å†…å­˜æ•°æ®åº“è¿›è¡Œæ¼”ç¤º
	config := db.DefaultConfig("sqlite", ":memory:")
	database, err := db.Open(config)
	if err != nil {
		return nil, fmt.Errorf("failed to open database: %w", err)
	}

	// åˆ›å»ºè¡¨
	schema := `
	CREATE TABLE IF NOT EXISTS users (
		id TEXT PRIMARY KEY,
		name TEXT NOT NULL,
		email TEXT UNIQUE NOT NULL,
		status TEXT NOT NULL DEFAULT 'active',
		role TEXT NOT NULL DEFAULT 'user',
		created_at DATETIME NOT NULL,
		updated_at DATETIME NOT NULL
	);

	CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
	CREATE INDEX IF NOT EXISTS idx_users_status ON users(status);
	CREATE INDEX IF NOT EXISTS idx_users_created_at ON users(created_at);
	`

	if _, err := database.ExecContext(context.Background(), schema); err != nil {
		return nil, fmt.Errorf("failed to create schema: %w", err)
	}

	// æ’å…¥ç¤ºä¾‹æ•°æ®
	insertSampleData(database)

	log.Println("[Database] Initialized successfully with sample data")
	return database, nil
}

func insertSampleData(database db.DB) {
	now := time.Now()
	users := []struct {
		id    string
		name  string
		email string
		role  string
	}{
		{"user-1", "Alice Johnson", "alice@example.com", "admin"},
		{"user-2", "Bob Smith", "bob@example.com", "user"},
		{"user-3", "Charlie Brown", "charlie@example.com", "user"},
		{"user-4", "Diana Prince", "diana@example.com", "user"},
		{"user-5", "Eve Davis", "eve@example.com", "user"},
	}

	for _, u := range users {
		query := `INSERT INTO users (id, name, email, status, role, created_at, updated_at)
		          VALUES (?, ?, ?, ?, ?, ?, ?)`
		_, err := database.ExecContext(context.Background(), query,
			u.id, u.name, u.email, "active", u.role, now, now)
		if err != nil {
			log.Printf("[Database] Warning: Failed to insert sample user %s: %v", u.name, err)
		}
	}

	log.Println("[Database] Inserted 5 sample users")
}

// ================================================
// 7. ä¸»å‡½æ•° - å¯åŠ¨æœåŠ¡å™¨
// ================================================

func main() {
	// åˆå§‹åŒ–æ•°æ®åº“
	database, err := initDatabase()
	if err != nil {
		log.Fatalf("Database initialization failed: %v", err)
	}
	defer database.Close()

	// åˆ›å»ºåº”ç”¨
	app := core.New(
		core.WithAddr(":8080"),
		core.WithDebug(),
		core.WithRequestID(),
		core.WithLogging(),
		core.WithRecovery(),
		core.WithCORS(),
	)

	// æ³¨å†Œè·¯ç”±
	registerRoutes(app.Router(), database)

	// å¯åŠ¨æœåŠ¡å™¨
	log.Println("========================================")
	log.Println("ğŸš€ CRUD Framework Demo Server Started")
	log.Println("========================================")
	log.Println("Server: http://localhost:8080")
	log.Println("")
	log.Println("ğŸ“š Try these endpoints:")
	log.Println("  GET    http://localhost:8080/users                    - List all users")
	log.Println("  GET    http://localhost:8080/users?page=1&page_size=2 - Paginated list")
	log.Println("  GET    http://localhost:8080/users?sort=-created_at   - Sorted by date")
	log.Println("  GET    http://localhost:8080/users?status=active      - Filter by status")
	log.Println("  GET    http://localhost:8080/users?search=alice       - Search users")
	log.Println("  GET    http://localhost:8080/users/user-1             - Get single user")
	log.Println("  POST   http://localhost:8080/users                    - Create new user")
	log.Println("  PUT    http://localhost:8080/users/user-1             - Update user")
	log.Println("  DELETE http://localhost:8080/users/user-1             - Delete user")
	log.Println("")
	log.Println("ğŸ“– Example POST body:")
	log.Println(`  {"name": "New User", "email": "new@example.com", "role": "user"}`)
	log.Println("")
	log.Println("========================================")

	if err := app.Boot(); err != nil {
		log.Fatalf("Server failed: %v", err)
	}
}

func registerRoutes(r *router.Router, database db.DB) {
	// é¦–é¡µ
	r.Get("/", func(w http.ResponseWriter, req *http.Request) {
		html := `<!DOCTYPE html>
<html>
<head>
    <title>CRUD Framework Demo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 50px auto; padding: 20px; }
        h1 { color: #333; }
        .endpoint { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .method { display: inline-block; width: 80px; font-weight: bold; }
        .get { color: #28a745; }
        .post { color: #007bff; }
        .put { color: #ffc107; }
        .delete { color: #dc3545; }
        code { background: #e9ecef; padding: 2px 5px; border-radius: 3px; }
        .example { background: #e3f2fd; padding: 15px; margin: 20px 0; border-left: 4px solid #2196f3; }
    </style>
</head>
<body>
    <h1>ğŸš€ CRUD Framework Demo</h1>
    <p>Welcome to the Plumego CRUD Framework demonstration. This server showcases a complete RESTful API built with the database-integrated CRUD framework.</p>

    <h2>Available Endpoints</h2>

    <div class="endpoint">
        <span class="method get">GET</span> <code>/users</code>
        <p>List all users with optional pagination, filtering, and sorting</p>
        <ul>
            <li><code>?page=1&page_size=10</code> - Pagination</li>
            <li><code>?sort=-created_at</code> - Sort by created date (descending)</li>
            <li><code>?status=active</code> - Filter by status</li>
            <li><code>?search=alice</code> - Search by name or email</li>
        </ul>
    </div>

    <div class="endpoint">
        <span class="method get">GET</span> <code>/users/:id</code>
        <p>Get a single user by ID</p>
    </div>

    <div class="endpoint">
        <span class="method post">POST</span> <code>/users</code>
        <p>Create a new user</p>
        <div class="example">
            <strong>Example Request Body:</strong>
            <pre>{"name": "John Doe", "email": "john@example.com", "role": "user"}</pre>
        </div>
    </div>

    <div class="endpoint">
        <span class="method put">PUT</span> <code>/users/:id</code>
        <p>Update an existing user</p>
        <div class="example">
            <strong>Example Request Body:</strong>
            <pre>{"name": "John Updated", "status": "inactive"}</pre>
        </div>
    </div>

    <div class="endpoint">
        <span class="method delete">DELETE</span> <code>/users/:id</code>
        <p>Delete a user</p>
    </div>

    <h2>Features Demonstrated</h2>
    <ul>
        <li>âœ… Generic Repository pattern with type safety</li>
        <li>âœ… Automatic SQL query generation</li>
        <li>âœ… Pagination with metadata (total_pages, has_next, has_prev)</li>
        <li>âœ… Multi-field sorting (ascending/descending)</li>
        <li>âœ… Flexible filtering</li>
        <li>âœ… Full-text search</li>
        <li>âœ… Lifecycle hooks (Before/After operations)</li>
        <li>âœ… Resource transformation for API responses</li>
        <li>âœ… Database integration with store/db</li>
    </ul>

    <h2>Quick Test with curl</h2>
    <div class="example">
        <pre># List users
curl http://localhost:8080/users

# Create user
curl -X POST http://localhost:8080/users \
  -H "Content-Type: application/json" \
  -d '{"name": "Test User", "email": "test@example.com", "role": "user"}'

# Get user
curl http://localhost:8080/users/user-1

# Update user
curl -X PUT http://localhost:8080/users/user-1 \
  -H "Content-Type: application/json" \
  -d '{"name": "Updated Name"}'

# Delete user
curl -X DELETE http://localhost:8080/users/user-1</pre>
    </div>
</body>
</html>`
		w.Header().Set("Content-Type", "text/html; charset=utf-8")
		w.Write([]byte(html))
	})

	// ç”¨æˆ· CRUD ç«¯ç‚¹
	ctrl := NewUserController(database)

	r.GetCtx("/users", ctrl.IndexCtx)
	r.GetCtx("/users/:id", ctrl.ShowCtx)
	r.PostCtx("/users", ctrl.CreateCtx)
	r.PutCtx("/users/:id", ctrl.UpdateCtx)
	r.DeleteCtx("/users/:id", ctrl.DeleteCtx)

	// å¥åº·æ£€æŸ¥
	r.Get("/health", func(w http.ResponseWriter, req *http.Request) {
		contract.WriteResponse(w, req, http.StatusOK, map[string]string{
			"status": "healthy",
			"time":   time.Now().Format(time.RFC3339),
		}, nil)
	})
}
